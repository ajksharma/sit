This is a better patch with additional tests included.
